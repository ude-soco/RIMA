#!/usr/bin/env bash
set -euo pipefail

rm -f "${MODEL_DIR}/.done"

# ENV LDA_MODEL_FILE=keyword_extractor/lda-1000-semeval2010.py3.pickle.gz
if [ -f "${MODEL_DIR}/${LDA_MODEL_FILE}" ]; then
  echo "${MODEL_DIR}/${LDA_MODEL_FILE} already present"
else
  echo "${MODEL_DIR}/${LDA_MODEL_FILE} missing; downloading now ..."
  wget --continue -O "${TEMP_DIR}/lda.gz" ${LDA_MODEL_URL}
  mkdir -p `dirname ${MODEL_DIR}/${LDA_MODEL_FILE}` && mv -f "${TEMP_DIR}/lda.gz" ${MODEL_DIR}/${LDA_MODEL_FILE}
fi

# ENV NLTK_MODEL_DIR=nltk
if [ -d "/home/app/nltk_data" ]; then
  echo "NLTK data packaged in container image; copying now ..."
  mkdir -p $MODEL_DIR/$NLTK_MODEL_DIR
  cp -Rf /home/app/nltk_data/* $MODEL_DIR/$NLTK_MODEL_DIR
else
  echo "NLTK data not packaged in container image;  downloading now ..."
  python -m nltk.downloader -d $MODEL_DIR/$NLTK_MODEL_DIR $NLTK_PACKAGES
fi

# ENV CORE_NLP_MODEL_URL=http://nlp.stanford.edu/software/stanford-corenlp-full-2018-02-27.zip
# ENV CORE_NLP_MODEL_DIR=stanford-corenlp
if [ -d "${MODEL_DIR}/${CORE_NLP_MODEL_DIR}/" ]; then
  echo "${MODEL_DIR}/${CORE_NLP_MODEL_DIR}/ already present"
else
  echo "${MODEL_DIR}/${CORE_NLP_MODEL_DIR}/ missing; downloading now ..."
  wget --continue -O "${TEMP_DIR}/stanford-corenlp.zip" ${CORE_NLP_MODEL_URL}
  unzip -o "${TEMP_DIR}/stanford-corenlp.zip" -d "${MODEL_DIR}/${CORE_NLP_MODEL_DIR}/"
fi

# ENV MS_MARCO_MODEL_URL=https://uni-duisburg-essen.sciebo.de/s/z1k3w8Oxb8RRd4M/download
# ENV MS_MARCO_MODEL_DIR=msmarco
if [ -d "${MODEL_DIR}/${MS_MARCO_MODEL_DIR}/" ]; then
  echo "${MODEL_DIR}/${MS_MARCO_MODEL_DIR}/ already present"
else
  echo "${MODEL_DIR}/${MS_MARCO_MODEL_DIR}/ missing; downloading now ..."
  wget --continue -O "${TEMP_DIR}/msmarco.zip" ${MS_MARCO_MODEL_URL}
  unzip -o "${TEMP_DIR}/msmarco.zip" -d "${MODEL_DIR}/${MS_MARCO_MODEL_DIR}/"
fi

# ENV ELMO_WEIGHT_MODEL_URL=https://s3-us-west-2.amazonaws.com/allennlp/models/elmo/2x4096_512_2048cnn_2xhighway/elmo_2x4096_512_2048cnn_2xhighway_weights.hdf5
# ENV ELMO_WEIGHT_MODEL_FILE=elmo/elmo.hdf5
if [ -f "${MODEL_DIR}/${ELMO_WEIGHT_MODEL_FILE}" ]; then
  echo "${MODEL_DIR}/${ELMO_WEIGHT_MODEL_FILE} already present"
else
  echo "${MODEL_DIR}/${ELMO_WEIGHT_MODEL_FILE} missing; downloading now ..."
  mkdir -p "${MODEL_DIR}/${ELMO_WEIGHT_MODEL_FILE}"
  wget --continue -O "${MODEL_DIR}/${ELMO_WEIGHT_MODEL_FILE}" $ELMO_WEIGHT_MODEL_URL
fi

touch "${MODEL_DIR}/.done"
echo "Model downloads succeeded"
